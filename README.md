# OpenRM-2024



**æ­¤ç®—æ³•åº“ä¸ºåŒ—æ´‹æœºç”²2024è§†è§‰ç®—æ³•åº“**


**é€‚é…å¼€æºè‡ªç„æ¡†æ¶ [TJURM-2024](https://github.com/HHgzs/TJURM-2024)**







## ğŸŒŸ ä»£ç äº®ç‚¹ ğŸŒŸ



### ğŸ–ï¸ å…¨é˜µå®¹

é›†ç»“**è‡ªç„ï¼Œæ‰“ç¬¦ï¼Œæ‰“å‰å“¨**äºä¸€ä½“ï¼Œé€‚é…**æ­¥å…µï¼Œå“¨å…µï¼Œè‹±é›„ï¼Œæ— äººæœº**å…¨ä½“å…µç§



### ğŸš€ åŠ¨æ€é“¾æ¥åº“è®¾è®¡

æœ¬è‡ªç„ç®—æ³•åº“é‡‡ç”¨åŠ¨æ€é“¾æ¥åº“è®¾è®¡ï¼Œ**å¿«é€Ÿä¸Šæ‰‹ï¼Œä¾¿æ·è°ƒç”¨**

- æ”¯æŒcmake è°ƒç”¨ find_package
- å…¨åŠ¨æ€é“¾æ¥åº“è®¾è®¡

ğŸ‰ğŸ‰ğŸ‰ **ä½¿ç”¨ä½“éªŒç±»ä¼¼ OpenCV** ğŸ‰ğŸ‰ğŸ‰





### ğŸ™Œ ç®—æ³•ä¸æ¡†æ¶åˆ†ç¦»

**ç®—æ³•åº“**

- ç®—æ³•åº“é‡‡ç”¨åŠ¨æ€é“¾æ¥åº“çš„å½¢å¼ï¼Œæ–¹ä¾¿é€‚é…æ›´å¤šè§†è§‰é¡¹ç›®ï¼Œä¾¿äºä»£ç å¤ç”¨

- https://github.com/HHgzs/OpenRM-2024



**è‡ªç„æ¡†æ¶**

- è‡ªç„æ¡†æ¶æ— å…·ä½“çš„ç®—æ³•å®ç°ï¼Œé€šè¿‡è°ƒç”¨ç®—æ³•åº“ä¸­å®ç°çš„ç®—æ³•ï¼Œæ­å»ºæµæ°´çº¿æ¶æ„ï¼Œå®ç°é«˜æ•ˆä¸é«˜æ‹“å±•æ€§

- https://github.com/HHgzs/TJURM-2024







## ğŸ¦º ç¯å¢ƒé…ç½® ğŸ¦º

ä¸‹é¢æ˜¯ç¯å¢ƒé…ç½®çš„ä¿å§†çº§æ•™ç¨‹ï¼Œå¦‚æœ‰ç–‘é—®è¯·åœ¨è®¨è®ºåŒºæˆ–äº¤æµç¾¤ç•™è¨€

**æ³¨æ„**ï¼š

- é¡¹ç›®ä½¿ç”¨ **OpenCV4.5.4**ï¼Œæ‚¨ä½¿ç”¨çš„ç‰ˆæœ¬åº”å°½é‡ä¸é¡¹ç›®ä¿æŒä¸€è‡´

- å¯æŒ‰ç…§ä¸‹é¢ç¯å¢ƒé…ç½®æµç¨‹è¿›è¡Œå¤šç‰ˆæœ¬å¹¶å­˜å®‰è£…

**æç¤º**

- **æ— Nvidiaç¡¬ä»¶ï¼ŒOpenRMä»å¯æ­£å¸¸ç¼–è¯‘ï¼Œtensorrtæ¨¡å—è‡ªåŠ¨ä¸å‚ä¸ç¼–è¯‘**
- **æ— å¤§æ’ç›¸æœºé©±åŠ¨ï¼Œä»“åº“ä»å¯æ­£å¸¸ç¼–è¯‘ï¼Œå·¥ä¸šç›¸æœºæ¨¡å—ä¸å‚ä¸ç¼–è¯‘**



### åŸºæœ¬ç¯å¢ƒ

---



#### gcc/g++

æœ¬é¡¹ç›®ä¸­ä½¿ç”¨çš„ `gcc/g++` ç‰ˆæœ¬ä¸º `8.4.0`ï¼Œè¯·ç¡®ä¿æ‚¨çš„  `gcc/g++` ç‰ˆæœ¬èƒ½å¤Ÿæ­£å¸¸ç¼–è¯‘æœ¬é¡¹ç›®

---



#### cmake

æœ¬é¡¹ç›®ä½¿ç”¨çš„ `cmake` ç‰ˆæœ¬ä¸º `3.22.1`ï¼Œè‹¥æœ¬æœº `cmake` ç‰ˆæœ¬ä½äº `3.12` éœ€è¦æ›´æ–° `cmake` ç‰ˆæœ¬

æŸ¥çœ‹ `cmake` ç‰ˆæœ¬ä¸ `gcc/g++` ä¹‹é—´çš„é€‚é…å…³ç³»ï¼š

[CXX_STANDARD](https://cmake.org/cmake/help/v3.12/prop_tgt/CXX_STANDARD.html)


é¦–å…ˆä¸‹è½½éœ€è¦ç‰ˆæœ¬çš„ `cmake`

[cmake](https://cmake.org/files/)

æœ¬é¡¹ç›®ä¸­ä¸‹è½½çš„æ˜¯ `cmake-3.22.1.tar.gz`ï¼Œ


è§£å‹åè¿›å…¥æ–‡ä»¶å¤¹

```bash
tar -xzvf  cmake-3.22.1.tar.gz
cd cmake-3.22.1
```

å¦‚æœæ²¡æœ‰binç›®å½•å°±ç¼–è¯‘å®‰è£…

```bash
./bootstrap
make -j6
sudo make install
```

å¦‚æœæœ‰binç›®å½•å°±å¯ä»¥ç›´æ¥é‡å‘½åæ–‡ä»¶å¤¹åæ‹·è´åˆ°è½¯ä»¶ç›®å½•å³å¯

```bash
# è¿”å›ä¸Šçº§ç›®å½•
cd ..
mv cmake-3.22.1 cmake
sudo cp -r ./cmake /usr/local
```

ä¿®æ”¹ç¯å¢ƒå˜é‡

```bash
vim ~/.bashrc
```

åœ¨æ–‡ä»¶æœ€åæ·»åŠ  `export PATH=/usr/local/cmake/bin:$PATH`

```bash
source ~/.bashrc
cmake --version
```

æ­¤æ—¶åº”è¯¥èƒ½å¤Ÿæ­£ç¡®æ‰“å°ç‰ˆæœ¬ä¿¡æ¯ï¼Œå¦‚æœåç»­è¿˜æ˜¯æ— æ³•ä½¿ç”¨cmakeï¼Œåˆ™éœ€è¦åŠ ä¸€æ­¥è½¯é“¾æ¥

```bash
sudo ln -s /usr/local/cmake/bin/cmake /usr/local/bin/camke
```

---



#### Eigen

å¯ä»¥ä½¿ç”¨aptå®‰è£…

```bash
sudo apt install libeigen3-dev
```

ä¹Ÿå¯ä»¥é€‰æ‹©æºç ç¼–è¯‘
[Eigen](http://eigen.tuxfamily.org/index.php?title=Main_Page)
[eigen-git-mirror](https://github.com/eigenteam/eigen-git-mirror)


ç¼–è¯‘å®‰è£…

```bash
cd eigen-git-mirror
mkdir build
cd build
cmake ..
sudo make install
```

---





#### Ceres

é¦–å…ˆå®‰è£…å¿…è¦ä¾èµ–

```bash
sudo apt-get install liblapack-dev libsuitesparse-dev libcxsparse3 libgflags-dev libgoogle-glog-dev libgtest-dev
```

ä»Githubä¸Šè·å–ceresæºç 
[ceres-solver](https://github.com/ceres-solver/ceres-solver)

è¿™é‡Œä½¿ç”¨çš„æ˜¯`1.14.0`ç‰ˆæœ¬ï¼Œä¸‹è½½tar.gzå‹ç¼©åŒ…


è§£å‹ç¼©å¹¶ç¼–è¯‘

```bash
tar -zxvf ceres-solver-1.14.0.tar.gz 
cd ceres-solver-1.14.0/
mkdir build
cd build/

cmake ..
make -j6
sudo make install
```

---





#### Ncurses

ä¸€æ¡æŒ‡ä»¤å®‰è£…

```bash
sudo apt-get install libncurses5-dev libncursesw5-dev
```

æ³¨æ„ç”±äºncuesesä¸­çš„å®å®šä¹‰ `OK`ä¸ `OpenCV` ä¸­å†²çªï¼Œæ‰€ä»¥éœ€è¦å¯¹å…¶è¿›è¡Œä¿®æ”¹

é¦–å…ˆä¿®æ”¹æƒé™

```bash
sudo chmod 770 /usr/include/curses.h
```

ä½¿ç”¨VSCodeå…¨å±€æ›¿æ¢ï¼Œå°† `OK` ä¿®æ”¹ä¸º `KO`

æœ€åå°†æƒé™æ”¹å›æ¥

```bash
sudo chmod 440 /usr/include/curses.h
```

---





#### Cudaã€cudnnã€TensorRT

ç”±äºä¸åŒè®¾å¤‡å±æ€§ä¸ä¸€è‡´ï¼Œè¯·è‡ªè¡Œå®‰è£…ï¼Œæœ¬é¡¹ç›®æ‰€ä½¿ç”¨**Nvidia NX**åŠ**AGX**ç³»åˆ—ç³»ç»Ÿç¯å¢ƒè‡ªå¸¦**CUDA**å¥—è£…

**æ— Nvidiaç¡¬ä»¶ï¼Œæ— CUDAï¼ŒOpenRMä»å¯æ­£å¸¸ç¼–è¯‘ï¼Œtensorrtæ¨¡å—ä¸å‚ä¸ç¼–è¯‘**

---





#### OpenCV 4.5.4 å¤šç‰ˆæœ¬å¹¶å­˜

é¦–å…ˆå®‰è£…å¿…è¦ä¾èµ–

```bash
sudo apt-get update
sudo apt-get install build-essential cmake pkg-config 
sudo apt-get install libgtk2.0-dev libavcodec-dev libavformat-dev  libtiff4-dev  libswscale-dev libjasper-dev
sudo apt-get install python-dev python-numpy libtbb2 libtbb-dev libjpeg-dev libpng-dev libtiff-dev libjasper-dev libdc1394-22-dev
```

**ä¾èµ–å¦‚è‹¥ä¸å®Œæ•´ï¼Œè¯·è‡ªè¡Œä¸Šç½‘æœç´¢**



åˆ†åˆ«å‰å¾€ `OpenCV` å’Œ `opencv_contrib` çš„ github ä»“åº“ä¸‹è½½æºç 

æ³¨æ„ OpenCV å’Œ opencv_contrib çš„ç‰ˆæœ¬è¦å¯¹åº”æ­£ç¡®

- [opencv](https://github.com/opencv/opencv/releases)
- [opencv_contrib](https://github.com/opencv/opencv_contrib/tags)


å°† `opencv-4.5.4.zip` å’Œ `opencv_contrib-4.5.4.zip` æ”¾åœ¨åŒä¸€æ–‡ä»¶å¤¹ï¼Œåˆ†åˆ«è§£å‹ç¼©

```bash
unzip opencv-4.5.4.zip
unzip opencv_contrib-4.5.4.zip
cd opencv-4.5.4
mkdir build
cd build
```

åœ¨/usr/local/ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜æ”¾opencvçš„ç‰ˆæœ¬

```bash
mkdir /usr/local/opencv4.5.4
```

å¦‚æœé€‰æ‹©å®‰è£…opencvçš„cudaåŠŸèƒ½å’Œopencvæ‹“å±•åŒ…ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤

```bash
cmake \
-DCMAKE_BUILD_TYPE=Release \
-DCMAKE_INSTALL_PREFIX=/usr/local/opencv4.5.4 \
-DOPENCV_ENABLE_NONFREE=1 \
-DBUILD_opencv_python2=1 \
-DBUILD_opencv_python3=1 \
-DWITH_FFMPEG=1 \
-DCUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda \
-DCUDA_ARCH_BIN=7.2 \
-DCUDA_ARCH_PTX=7.2 \
-DWITH_CUDA=1 \
-DENABLE_FAST_MATH=1 \
-DCUDA_FAST_MATH=1 \
-DWITH_CUBLAS=1 \
-DOPENCV_GENERATE_PKGCONFIG=1 \
-DOPENCV_EXTRA_MODULES_PATH=../../opencv_contrib-4.5.4/modules ..
```



**CUDA_ARCH**ç‰ˆæœ¬åº”ä¸è‡ªå·±çš„**CUDA**ä¸€è‡´ï¼Œè¿™é‡Œä»…ä»‹ç»å¸¦ CUDA çš„ OpenCV å®‰è£…æ–¹æ³•ï¼Œä¸å¸¦ CUDA çš„å®‰è£…åŒç†



æ¥ç€æ‰§è¡Œç¼–è¯‘å®‰è£…

```bash
make -j6
sudo make install
```

---





#### å¤§æ’é©±åŠ¨

å‰å¾€å¤§æ’å®˜ç½‘ä¸‹è½½c++é©±åŠ¨

https://www.daheng-imaging.com/downloads/

æœ¬é¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯ ã€å¤§æ’ç›¸æœºã€‘ã€USB3.0ã€‘ã€ARM Linuxã€‘

**Galaxy Linux-armhf-Gige-U3 SDK**

å¦‚ä¸å®‰è£…ç›¸æœºé©±åŠ¨ï¼Œä»“åº“ä»å¯æ­£å¸¸ç¼–è¯‘

---







### OpenRM å®‰è£…

ä½¿ç”¨ `run.sh` è‡ªåŠ¨å®‰è£…

```bash
cd OpenRM-2024
sudo ./run.sh -t
```



`run.sh` æœ‰å¤šç§åŠŸèƒ½ï¼š

- **-t** ç¼–è¯‘å®‰è£…**OpenRM**åŠ¨æ€é“¾æ¥åº“åï¼Œç¼–è¯‘å®‰è£…åä¸º **openrm** çš„å‚æ•°é¢æ¿ç¨‹åº
- **-r** åˆ é™¤ç¼–è¯‘å’Œå®‰è£…ç»“æœï¼Œå¹¶é‡æ–°ç¼–è¯‘
- **-d** å½»åº•åˆ é™¤ OpenRM
- **-i** é‡æ–°å®‰è£…
- **-g \<arg>** è°ƒç”¨gitï¼Œéœ€æ·»åŠ commit
- ä¸æ·»åŠ å‚æ•°ï¼Œåªç¼–è¯‘å®‰è£… **OpenRM** åŠ¨æ€é“¾æ¥åº“





## ğŸ§© æ¨¡å—ä»‹ç» ğŸ§©



### cudatools

cudaç¼–ç¨‹éƒ¨åˆ†ï¼Œè°ƒç”¨**NVCC**ç¼–è¯‘ï¼Œç›®å‰å®ç°äº†å›¾åƒresizeåŠŸèƒ½

```c++
void rm::resize(
    uint8_t* src,
    int src_width,
    int src_height,
    float* dst,
    int dst_width,
    int dst_height,
    void* cuda_stream
);
```



---



### tensorrt

è°ƒç”¨tensorrtåŠ é€Ÿæ¨ç†ï¼Œä»¥åŠyoloç³»çš„nmsç®—æ³•

```c++
bool rm::initTrtOnnx(
    const std::string& onnx_file,
    const std::string& engine_file,
    nvinfer1::IExecutionContext** context,
    unsigned int batch_size = 1U
);

bool rm::initTrtEngine(
    const std::string& engine_file,
    nvinfer1::IExecutionContext** context
);

bool rm::initCudaStream(
    cudaStream_t* stream
);

void rm::detectEnqueue(
    float* input_device_buffer,
    float* output_device_buffer,
    nvinfer1::IExecutionContext** context,
    cudaStream_t* stream
);

void rm::detectOutput(
    float* output_host_buffer,
    const float* output_device_buffer,
    cudaStream_t* stream,
    size_t output_struct_size,
    int bboxes_num,
    int batch_size = 1
); 

void rm::detectOutputClassify(
    float* output_host_buffer,
    const float* output_device_buffer,
    cudaStream_t* stream,
    int class_num
); 

void rm::mallocYoloCameraBuffer(
    uint8_t** rgb_host_buffer,
    uint8_t** rgb_device_buffer,
    int rgb_width,
    int rgb_height,
    int batch_size = 1,
    int channels = 3
);


void rm::mallocYoloDetectBuffer(
    float** input_device_buffer,
    float** output_device_buffer,
    float** output_host_buffer,
    int input_width,
    int input_height,
    size_t output_struct_size,
    int bboxes_num,
    int batch_size = 1,
    int channels = 3
);

void rm::mallocClassifyBuffer(
    float** input_host_buffer,
    float** input_device_buffer,
    float** output_device_buffer,
    float** output_host_buffer,
    int input_width,
    int input_height,
    int class_num,
    int channels = 3
);

void rm::freeYoloCameraBuffer(
    uint8_t* rgb_host_buffer,
    uint8_t* rgb_device_buffer
);


void rm::freeYoloDetectBuffer(
    float* input_device_buffer,
    float* output_device_buffer,
    float* output_host_buffer
);

void rm::freeClassifyBuffer(
    float* input_host_buffer,
    float* input_device_buffer,
    float* output_device_buffer,
    float* output_host_buffer
);

void rm::memcpyYoloCameraBuffer(
    uint8_t* rgb_mat_data,
    uint8_t* rgb_host_buffer,
    uint8_t* rgb_device_buffer,
    int rgb_width,
    int rgb_height,
    int channels = 3
);

void rm::memcpyClassifyBuffer(
    uint8_t* mat_data,
    float* input_host_buffer,
    float* input_device_buffer,
    int input_width,
    int input_height,
    int channels = 3
);

std::vector<YoloRect> rm::yoloArmorNMS_V5C36(
    float* output_host_buffer,
    int output_bboxes_num,
    int armor_classes_num,
    float confidence_threshold,
    float nms_threshold,
    int input_width,
    int input_height,
    int infer_width,
    int infer_height
);

std::vector<YoloRect> rm::yoloArmorNMS_V5(
    float* output_host_buffer,
    int output_bboxes_num,
    int armor_classes_num,
    float confidence_threshold,
    float nms_threshold,
    int input_width,
    int input_height,
    int infer_width,
    int infer_height
);

std::vector<YoloRect> rm::yoloArmorNMS_FP(
    float* output_host_buffer,
    int output_bboxes_num,
    int classes_num,
    float confidence_threshold,
    float nms_threshold,
    int input_width,
    int input_height,
    int infer_width,
    int infer_height
);

std::vector<YoloRect> rm::yoloArmorNMS_FPX(
    float* output_host_buffer,
    int output_bboxes_num,
    int classes_num,
    float confidence_threshold,
    float nms_threshold,
    int input_width,
    int input_height,
    int infer_width,
    int infer_height
);
```

---



### attach

æ”»å‡»ç›®æ ‡é€‰æ‹©åŠåˆ‡æ¢æ¨¡å—

```c++
class AttackInterface;
```

```c++
bool rm::isValidArmorID(ArmorID armor_id, char valid_byte);
double rm::getAngleOffsetTargetToReferee(
    const double yaw,
    const double pitch,
    const double target_x,
    const double target_y,
    const double target_z,
    const double referee_x,
    const double referee_y,
    const double referee_z,
    const double referee_yaw = 0.0,
    const double referee_pitch = 0.0,
    const double axis_x = 0.0,
    const double axis_y = 0.0,
    const double axis_z = 0.0);
```



### kalman

åŸºäºKFå’ŒEKFçš„è¿åŠ¨é¢„æµ‹æ¨¡å‹

```c++
class rm::AntitopV1;
class rm::AntitopV2;
class rm::AntitopV3;
```

```c++
class rm::OutpostV1;
class rm::OutpostV2;
```

```c++
class rm::RuneV1;
class rm::RuneV2;
```


```c++
class rm::TQstateV1;
class rm::TQstateV2;
class rm::TQstateV3;
class rm::TQstateV4;
```

```c++
class rm::trajectoryV1;
```



### uniterm

ç”¨äºopenrmå‚æ•°é¢æ¿ç¨‹åºçš„åº“ï¼Œå¯è¢«è°ƒç”¨æ·»åŠ LOG

```c++
void rm::message(const std::string& name, int msg);
void rm::message(const std::string& name, float msg);
void rm::message(const std::string& name, double msg);
void rm::message(const std::string& name, char msg);
void rm::message(const std::string& name, MsgNum msg);
void rm::message(const std::string& msg, MSG type = MSG_NOTE);
void rm::message(const std::string& info, int img_width, int img_height, cv::Rect rect);
void rm::message(const std::string& info, int img_width, int img_height, std::vector<cv::Point2f> four_points);
void rm::message(const std::string& info, int img_width, int img_height, cv::Point2f pointX);
```



### pointer

ç”¨äºä¼ ç»Ÿè§†è§‰æŸ¥æ‰¾ç¯æ¡å’Œå››ç‚¹å®šä½çš„æ¨¡å—



### solver

å®ç°äº†ä¸Šæµ·äº¤é€šå¤§å­¦äº¤é¾™æˆ˜é˜Ÿæå‡ºçš„åŸºäºä¸‰åˆ†æ³•çš„pnpè§£ç®—



### video

æ‘„åƒå¤´é©±åŠ¨æ¥å£ï¼Œæ”¯æŒUVCç›¸æœºå’Œå¤§æ’ç›¸æœº



### serial

ä¸²å£é€šè®¯ï¼Œæ”¯æŒusbè½¬ttlï¼Œä»¥åŠè™šæ‹Ÿä¸²å£



### tf

åæ ‡è½¬æ¢ï¼Œå¯¹è‡ªç„ä¸­ä½¿ç”¨çš„åæ ‡è½¬æ¢è¿›è¡Œäº†å…·ä½“å®ç°



### delay

é£è¡Œå»¶è¿Ÿè®¡ç®—



### print

è°ƒå‚æ‰“å°å·¥å…·



### timer

æ—¶é—´æ¨¡å—









## ğŸ’¡ æ‰©å±•æ–¹æ³• ğŸ’¡




ä¸€å…±éœ€è¦ä¿®æ”¹äº”å¤„ï¼Œä¸‹é¢ä»¥æ·»åŠ `openrm_timer`ä¸ºä¾‹ï¼Œå…¶æºç ä¸º`src/utils/timer.cpp`

`include/openrm.h`

```c++
#include "utils/timer.h"
```

`src/utils/CMakeLists.txt`

```cmake
add_library(
    openrm_timer
        SHARED
)
target_sources(
    openrm_timer
        PRIVATE
        ${CMAKE_SOURCE_DIR}/src/utils/timer.cpp
)
target_include_directories(
    openrm_timer
        PRIVATE
        $<BUILD_INTERFACE:${CMAKE_SOURCE_DIR}/include>
        $<INSTALL_INTERFACE:include/openrm>
)
```


`CMakeLists.txt`

```cmake
add_subdirectory(src/utils)
```


`CMakeLists.txt`

```cmake
if (CUDA_FOUND)
    set(
        TARGETS_LIST
            openrm_timer
    )
else()
    set(
        TARGETS_LIST
            openrm_timer
    )
endif()
```

`cmake/OpenRMCopfig.cmake.in`

```cmake
set(
    OPENRM_LIBS
        openrm::openrm_timer
)
```

`cmake/OpenRMConfig.cmake.in.nocuda`

```cmake
set(
    OPENRM_LIBS
        openrm::openrm_timer
)
```



